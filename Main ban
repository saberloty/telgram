import logging
import asyncio
import json
import os
from aiogram import Bot, Dispatcher, types, F
from aiogram.enums import ParseMode
from aiogram.types import (
    Message, KeyboardButton, ReplyKeyboardMarkup,
    InlineKeyboardMarkup, InlineKeyboardButton
)
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.state import State, StatesGroup
from keep_alive import keep_alive

API_TOKEN = '8177436123:AAG2RuDLbRI6HdgsCTa7_75TJwuQ151ohLA'
ADMIN_ID = 131555118
CHANNEL_ID = -1002798154695
USERS_FILE = "users.json"
BANNED_FILE = "banned_users.json"

logging.basicConfig(level=logging.INFO)
bot = Bot(token=API_TOKEN, parse_mode=ParseMode.HTML)
dp = Dispatcher(storage=MemoryStorage())

class RegisterState(StatesGroup):
    waiting_for_name = State()
    waiting_for_instagram = State()
    waiting_for_phone = State()

def load_users():
    if os.path.exists(USERS_FILE):
        with open(USERS_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}

def save_users(data):
    with open(USERS_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def load_banned():
    if os.path.exists(BANNED_FILE):
        with open(BANNED_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return []

def save_banned(data):
    with open(BANNED_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

users = load_users()
banned_users = load_banned()

def user_keyboard(is_admin=False):
    buttons = []
    if is_admin:
        buttons.append([KeyboardButton(text="ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†")])
    else:
        buttons = [
            [KeyboardButton(text="ğŸ“ Ø§Ø±Ø³Ø§Ù„ÛŒâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§")],
            [KeyboardButton(text="ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†")]
        ]
    return ReplyKeyboardMarkup(keyboard=buttons, resize_keyboard=True)

@dp.message(F.text == "/start")
async def cmd_start(message: Message, state: FSMContext):
    user_id = str(message.from_user.id)

    if message.from_user.id == ADMIN_ID:
        await message.answer("ğŸ‘‘ Ø§Ø¯Ù…ÛŒÙ† Ø¹Ø²ÛŒØ²ØŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.", reply_markup=user_keyboard(is_admin=True))
        return

    if user_id in banned_users:
        await message.answer("â›”ï¸ Ø´Ù…Ø§ Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ù…Ø­Ø±ÙˆÙ… Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.")
        return

    if user_id in users and users[user_id].get("completed"):
        await message.answer("âœ… Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
                             reply_markup=user_keyboard())
        return

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="âœ… Ø´Ø±ÙˆØ¹ Ø¹Ø¶ÙˆÛŒØª", callback_data="start_register")]
    ])
    await message.answer(
        f"Ø³Ù„Ø§Ù… {message.from_user.first_name} Ø¹Ø²ÛŒØ² ğŸ‘‹\nØ¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯.",
        reply_markup=kb
    )

@dp.callback_query(F.data == "start_register")
async def begin_register(callback: types.CallbackQuery, state: FSMContext):
    user_id = str(callback.from_user.id)
    if user_id in users and users[user_id].get("completed"):
        await callback.message.answer("âœ… Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.", reply_markup=user_keyboard())
        return

    users[user_id] = {"step": "ask_name"}
    save_users(users)
    await callback.message.answer("ğŸ“ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    await state.set_state(RegisterState.waiting_for_name)

@dp.message(RegisterState.waiting_for_name)
async def get_name(message: Message, state: FSMContext):
    user_id = str(message.from_user.id)
    users[user_id]["name"] = message.text
    users[user_id]["step"] = "ask_instagram"
    save_users(users)
    await message.answer("ğŸ“¸ Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    await state.set_state(RegisterState.waiting_for_instagram)

@dp.message(RegisterState.waiting_for_instagram)
async def get_instagram(message: Message, state: FSMContext):
    user_id = str(message.from_user.id)
    users[user_id]["instagram"] = message.text
    users[user_id]["step"] = "ask_phone"
    save_users(users)
    kb = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="ğŸ“± Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ Ù…Ù†", request_contact=True)]],
        resize_keyboard=True,
        one_time_keyboard=True
    )
    await message.answer("ğŸ“ Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø§Ø² Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø´Ù…Ø§Ø±Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:", reply_markup=kb)
    await state.set_state(RegisterState.waiting_for_phone)

@dp.message(RegisterState.waiting_for_phone, F.contact)
async def get_phone(message: Message, state: FSMContext):
    if message.contact.user_id != message.from_user.id:
        await message.answer("âš ï¸ Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø´Ù…Ø§Ø±Ù‡ Ø®ÙˆØ¯ØªØ§Ù† Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")
        return

    user_id = str(message.from_user.id)
    users[user_id].update({
        "phone": message.contact.phone_number,
        "username": message.from_user.username or "Ù†Ø¯Ø§Ø±Ø¯",
        "completed": True,
        "uploads": [],
        "is_vip": False
    })
    users[user_id].pop("step", None)
    save_users(users)

    await message.answer("âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!", reply_markup=user_keyboard())
    await bot.send_message(ADMIN_ID, f"""
ğŸ“ <b>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¬Ø¯ÛŒØ¯:</b>
ğŸ‘¤ Ù†Ø§Ù…: {users[user_id]['name']}
ğŸ“¸ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…: {users[user_id]['instagram']}
ğŸ“ Ø´Ù…Ø§Ø±Ù‡: {users[user_id]['phone']}
ğŸ”— ÛŒÙˆØ²Ø±Ù†ÛŒÙ…: @{users[user_id]["username"]}
ğŸ†” <a href="tg://user?id={user_id}">{user_id}</a>
""")
    await state.clear()

@dp.message(F.photo | F.video)
async def handle_media(message: Message):
    user_id = str(message.from_user.id)

    if user_id in banned_users:
        await message.answer("â›”ï¸ Ø´Ù…Ø§ Ø¨Ù† Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ùˆ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")
        return

    if user_id not in users or not users[user_id].get("completed"):
        await message.answer("Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯.")
        return

    file_type = "photo" if message.photo else "video"
    file_id = message.photo[-1].file_id if message.photo else message.video.file_id
    caption = message.caption or ""

    # Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
    admin_caption = f"{caption}\n\nğŸš©Ù…Ø´Ø®ØµØ§Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡:\nğŸ†” <a href='tg://user?id={user_id}'>{user_id}</a>\nğŸ”— Ø¢ÛŒØ¯ÛŒ: @{message.from_user.username or 'Ù†Ø¯Ø§Ø±Ø¯'}"
    await (bot.send_photo(ADMIN_ID, file_id, caption=admin_caption) if file_type == "photo"
           else bot.send_video(ADMIN_ID, file_id, caption=admin_caption))

    # Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ Ø¨Ø§ Ø§Ù…Ø¶Ø§
    full_caption = f"""{caption}

â–â–â–â–â–â–â–â–
âœ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø«Ø¨Øª Ù†Ø§Ù… Ø¯Ø± Ø±Ø¨Ø§Øª Ø²ÛŒØ± Ø´Ù…Ø§ Ù‡Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒÙ† Ú©Ø§Ù†Ø§Ù„ Ù…Ø·Ù„Ø¨ Ø¨ÙØ±Ø³ØªÛŒØ¯.ğŸ‘‡
@GolddancerBot

ğŸŒ | Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Û²Ûµ Ú©Ø§Ù†Ø§Ù„ Ø±Ù‚Øµ:ğŸ‘‡
https://t.me/addlist/0gZ1uuwjNKM1OWRk
â–â–â–â–â–â–â–â–

ğŸš©Ù…Ø´Ø®ØµØ§Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ø§ÛŒÙ† Ù…Ø·Ù„Ø¨:
ğŸ†” <a href='tg://user?id={user_id}'>{user_id}</a>
ğŸ”— Ø¢ÛŒØ¯ÛŒ: @{message.from_user.username or 'Ù†Ø¯Ø§Ø±Ø¯'}"""

    await (bot.send_photo(CHANNEL_ID, file_id, caption=full_caption) if file_type == "photo"
           else bot.send_video(CHANNEL_ID, file_id, caption=full_caption))

    users[user_id].setdefault("uploads", []).append({"type": file_type, "file_id": file_id})
    if not users[user_id].get("is_vip") and len(users[user_id]["uploads"]) >= 5:
        users[user_id]["is_vip"] = True
        await message.answer("ğŸ‰ ØªØ¨Ø±ÛŒÚ©! Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ø¶ÙˆÛŒØª VIP Ø§Ø±ØªÙ‚Ø§ ÛŒØ§ÙØªÛŒØ¯!")

    save_users(users)
    await message.answer("âœ… ÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.")

@dp.message(F.text == "ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†")
async def show_profile(message: Message):
    user_id = str(message.from_user.id)
    if user_id in banned_users:
        await message.answer("â›”ï¸ Ø´Ù…Ø§ Ø¨Ù† Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ùˆ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
        return

    data = users.get(user_id)
    if not data:
        await message.answer("Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.")
        return

    vip_status = "ğŸ– Ø¹Ø¶Ùˆ VIP" if data.get("is_vip") else "Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ"
    await message.answer(f"""
ğŸ‘¤ Ù†Ø§Ù…: {data['name']}
ğŸ“¸ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…: {data['instagram']}
ğŸ“ Ø´Ù…Ø§Ø±Ù‡: {data['phone']}
ğŸ”— ÛŒÙˆØ²Ø±Ù†ÛŒÙ…: @{data['username']}
ğŸ†” <a href="tg://user?id={user_id}">{user_id}</a>
ğŸ“‚ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ: {len(data.get('uploads', []))}
ğŸ… ÙˆØ¶Ø¹ÛŒØª: {vip_status}
""")

@dp.message(F.text == "ğŸ“ Ø§Ø±Ø³Ø§Ù„ÛŒâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§")
async def show_user_uploads(message: Message):
    user_id = str(message.from_user.id)
    if user_id in banned_users:
        await message.answer("â›”ï¸ Ø´Ù…Ø§ Ø¨Ù† Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ùˆ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
        return

    uploads = users.get(user_id, {}).get("uploads", [])
    if not uploads:
        await message.answer("Ù‡Ù†ÙˆØ² ÙØ§ÛŒÙ„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.")
        return

    for item in uploads:
        if item["type"] == "photo":
            await message.answer_photo(photo=item["file_id"])
        else:
            await message.answer_video(video=item["file_id"])

@dp.message(F.text == "ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†")
async def list_users(message: Message):
    if message.from_user.id != ADMIN_ID:
        return

    for uid, data in users.items():
        if data.get("completed"):
            vip_mark = "â­ï¸" if data.get("is_vip") else ""
            is_banned = uid in banned_users
            info = f"""
{vip_mark} ğŸ‘¤ Ù†Ø§Ù…: {data['name']}
ğŸ“¸ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…: {data['instagram']}
ğŸ“ Ø´Ù…Ø§Ø±Ù‡: {data['phone']}
ğŸ”— Ø¢ÛŒØ¯ÛŒ: @{data['username']}
ğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ: <a href='tg://user?id={uid}'>{uid}</a>
â›”ï¸ ÙˆØ¶Ø¹ÛŒØª: {"Ø¨Ù† Ø´Ø¯Ù‡" if is_banned else "ÙØ¹Ø§Ù„"}
"""
            buttons = [
                InlineKeyboardButton(text="ğŸ—‘ Ø­Ø°Ù", callback_data=f"delete_{uid}"),
                InlineKeyboardButton(text="ğŸ“ Ø§Ø±Ø³Ø§Ù„ÛŒâ€ŒÙ‡Ø§", callback_data=f"view_{uid}")
            ]
            if is_banned:
                buttons.append(InlineKeyboardButton(text="âœ… Ø±ÙØ¹ Ø¨Ù†", callback_data=f"unban_{uid}"))
            else:
                buttons.append(InlineKeyboardButton(text="â›”ï¸ Ø¨Ù†", callback_data=f"ban_{uid}"))

            keyboard = InlineKeyboardMarkup(inline_keyboard=[buttons])
            await message.answer(info, reply_markup=keyboard)

@dp.callback_query(F.data.startswith("delete_"))
async def handle_delete_user(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        return
    user_id = callback.data.replace("delete_", "")
    if user_id in users:
        users.pop(user_id)
        save_users(users)
        await callback.message.edit_text("âŒ Ú©Ø§Ø±Ø¨Ø± Ø­Ø°Ù Ø´Ø¯.")
        await callback.answer("Ø­Ø°Ù Ø´Ø¯.")

@dp.callback_query(F.data.startswith("view_"))
async def handle_view_uploads(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        return
    user_id = callback.data.replace("view_", "")
    uploads = users.get(user_id, {}).get("uploads", [])
    if not uploads:
        await callback.message.answer("Ú©Ø§Ø±Ø¨Ø± ÙØ§ÛŒÙ„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª.")
        return
    for item in uploads:
        if item["type"] == "photo":
            await bot.send_photo(chat_id=ADMIN_ID, photo=item["file_id"])
        else:
            await bot.send_video(chat_id=ADMIN_ID, video=item["file_id"])
    await callback.answer()

@dp.callback_query(F.data.startswith("ban_"))
async def handle_ban(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        return
    user_id = callback.data.replace("ban_", "")
    if user_id not in banned_users:
        banned_users.append(user_id)
        save_banned(banned_users)
        await bot.send_message(user_id, "âŒ Ú©Ø§Ø±Ø¨Ø±Ú¯Ø±Ø§Ù…ÛŒ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø±Ø¹Ø§ÛŒØª Ù†Ú©Ø±Ø¯Ù† Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø² Ø±Ø¨Ø§Øª Ø¨Ù† Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.")
        await callback.message.edit_text("â›”ï¸ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ø´Ø¯.")
        await callback.answer("Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ø´Ø¯")

@dp.callback_query(F.data.startswith("unban_"))
async def handle_unban(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        return
    user_id = callback.data.replace("unban_", "")
    if user_id in banned_users:
        banned_users.remove(user_id)
        save_banned(banned_users)
        await bot.send_message(user_id, "âœ… Ø´Ù…Ø§ Ø§Ø² Ø­Ø§Ù„Øª Ø¨Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯ Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø±Ø¨Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.")
        await callback.message.edit_text("âœ… Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯.")
        await callback.answer("Ø±ÙØ¹ Ø¨Ù† Ø´Ø¯")

async def main():
    await bot.send_message(ADMIN_ID, "âœ… Ø±Ø¨Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§Ø³Øª.")
    await dp.start_polling(bot)

if __name__ == "__main__":
    keep_alive()
    asyncio.run(main())
